<% 
  // Check if this is cached data view (will be set to false for fresh data)
  const isCached = typeof cached !== 'undefined' && cached === true;
  const hasSongs = typeof songs !== 'undefined' && songs && songs.length > 0;
%>

<% if (isCached) { %>
<!-- Loading message for cached data -->
<div id="loading-message" style="text-align: center; padding: 40px;">
  <div class="spinner" style="margin: 0 auto;"></div>
  <p style="margin-top: 20px; color: #666;">Loading cached songs...</p>
</div>

<!-- Error message for no cached data -->
<div id="error-message" style="display: none; text-align: center; padding: 40px;">
  <h2 style="color: #ff0000;">âŒ No Cached Data Found</h2>
  <p style="color: #666; margin: 20px 0;">You haven't fetched any songs yet.</p>
  <button class="start-btn" onclick="window.location.href='/refresh'">
    ğŸµ Fetch Songs Now
  </button>
</div>
<% } %>

<!-- Results content -->
<div id="results-content"<% if (isCached) { %> style="display: none;"<% } %>>
  <h1>ğŸµ Your Spotify Liked Songs</h1>
  
  <div class="stats">
    Total Songs: <strong<% if (isCached) { %> id="song-count"<% } %>><%= hasSongs ? songs.length : 0 %></strong>
    <% if (isCached) { %>
    <span class="cache-status-badge cached">ğŸ’¾ From Cache</span>
    <% } else if (hasSongs) { %>
    <span class="cache-status-badge fresh">ğŸ”„ Fresh Data</span>
    <% } %>
  </div>
  
  <p class="subtitle"<% if (isCached) { %> id="export-date"<% } %>><%= typeof exportDate !== 'undefined' ? exportDate : '' %></p>
  
  <% if (isCached) { %>
  <!-- Action buttons for cached view -->
  <div class="action-buttons" style="margin-bottom: 20px;">
    <button class="start-btn" onclick="refreshData()" style="margin-right: 10px;">
      ğŸ”„ Refresh Data
    </button>
    <button class="start-btn secondary-btn" onclick="clearCacheAndRefresh()">
      ğŸ—‘ï¸ Clear Cache
    </button>
  </div>
  <% } %>
  
  <!-- Download buttons -->
  <div class="download-section">
    <% if (isCached) { %>
      <a href="#" class="download-btn" onclick="event.preventDefault(); downloadAsFormat('txt');">ğŸ“„ Download TXT</a>
      <a href="#" class="download-btn" onclick="event.preventDefault(); downloadAsFormat('csv');">ğŸ“Š Download CSV</a>
      <a href="#" class="download-btn" onclick="event.preventDefault(); downloadAsFormat('detailed');">ğŸ“‹ Download Detailed</a>
      <a href="#" class="download-btn" onclick="event.preventDefault(); downloadAsFormat('uris');">ğŸ”— Download URIs</a>
    <% } else { %>
      <a href="/download/txt" class="download-btn">ğŸ“„ Download TXT</a>
      <a href="/download/csv" class="download-btn">ğŸ“Š Download CSV</a>
      <a href="/download/detailed" class="download-btn">ğŸ“‹ Download Detailed</a>
      <a href="/download/uris" class="download-btn">ğŸ”— Download URIs</a>
    <% } %>
  </div>

  <!-- Songs table -->
  <div class="table-container">
    <table>
      <thead>
        <tr>
          <th>#</th>
          <% if (isCached) { %>
            <!-- Client-side sorting for cached data -->
            <th class="sortable" onclick="sortTable('track')">
              Track Name
              <span class="sort-icon">â‡…</span>
            </th>
            <th class="sortable" onclick="sortTable('album')">
              Album
              <span class="sort-icon">â‡…</span>
            </th>
            <th class="sortable" onclick="sortTable('artist')">
              Artist(s)
              <span class="sort-icon">â‡…</span>
            </th>
          <% } else { %>
            <!-- Server-side sorting for fresh data -->
            <th class="sortable">
              <a href="/results?sortBy=track&sortOrder=<%= (currentSort.by === 'track' && currentSort.order === 'asc') ? 'desc' : 'asc' %>">
                Track Name
                <span class="sort-icon">
                  <% if (currentSort.by === 'track') { %>
                    <%= currentSort.order === 'asc' ? 'â–²' : 'â–¼' %>
                  <% } else { %>
                    â‡…
                  <% } %>
                </span>
              </a>
            </th>
            <th class="sortable">
              <a href="/results?sortBy=album&sortOrder=<%= (currentSort.by === 'album' && currentSort.order === 'asc') ? 'desc' : 'asc' %>">
                Album
                <span class="sort-icon">
                  <% if (currentSort.by === 'album') { %>
                    <%= currentSort.order === 'asc' ? 'â–²' : 'â–¼' %>
                  <% } else { %>
                    â‡…
                  <% } %>
                </span>
              </a>
            </th>
            <th class="sortable">
              <a href="/results?sortBy=artist&sortOrder=<%= (currentSort.by === 'artist' && currentSort.order === 'asc') ? 'desc' : 'asc' %>">
                Artist(s)
                <span class="sort-icon">
                  <% if (currentSort.by === 'artist') { %>
                    <%= currentSort.order === 'asc' ? 'â–²' : 'â–¼' %>
                  <% } else { %>
                    â‡…
                  <% } %>
                </span>
              </a>
            </th>
          <% } %>
          <th>Download</th>
        </tr>
      </thead>
      <tbody<% if (isCached) { %> id="songs-table-body"<% } %>>
        <% if (!isCached && hasSongs) { %>
          <!-- Server-side rendered songs for fresh data -->
          <% songs.forEach((item, index) => { %>
            <% const track = item.track; %>
            <% const artists = track.artists.map(artist => artist.name).join(', '); %>
            <tr>
              <td><%= index + 1 %></td>
              <td><%= track.name %></td>
              <td><%= track.album.name %></td>
              <td><%= artists %></td>
              <td>
                <a href="#" 
                   class="download-mp3-link" 
                   data-track="<%= track.name %>" 
                   data-artist="<%= artists %>"
                   onclick="downloadMP3(event, '<%= track.name %>', '<%= artists %>')">
                  ğŸµ MP3
                </a>
              </td>
            </tr>
          <% }); %>
        <% } else if (isCached) { %>
          <!-- Client-side rendered songs for cached data (populated by JS) -->
        <% } %>
      </tbody>
    </table>
  </div>
</div>

<script>
  // Stub function for MP3 downloads (functionality removed)
  function downloadMP3(event, trackName, artistName) {
    event.preventDefault();
    alert('MP3 download functionality has been removed.');
  }
</script>

<% if (isCached) { %>
<!-- Client-side scripts for cached view -->
<script>
  function refreshData() {
    // Use the refresh route instead of forcing re-authentication
    window.location.href = '/refresh';
  }
  
  function clearCacheAndRefresh() {
    if (confirm('Are you sure you want to clear the cache?')) {
      clearCache();
      // Use the refresh route to fetch new data
      window.location.href = '/refresh';
    }
  }
  
  function downloadAsFormat(format) {
    alert('To download files, please refresh your data from Spotify first.');
  }
  
  function sortTable(column) {
    // Sorting is implemented in load-cached.js
    console.log('Sort by:', column);
  }
</script>
<% } %>

